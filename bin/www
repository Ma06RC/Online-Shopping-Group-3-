#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require('../app');
var addresses = require('../addresses');
var debug = require('debug')('shop-2:server');
var http = require('http');
var https = require('https');
var models = require("../models");
var sequelize_fixtures = require('sequelize-fixtures');

/**
 * Get port from environment and store in Express.
 */

app.set('port', process.env.PORT || '3000');
app.set('port_secure', process.env.PORT_SECURE || '3001');
app.set('domain', process.env.DOMAIN || 'localhost');

addresses.ADDRESS = 'http://'+app.get('domain')+':'+app.get('port');
addresses.SECURE = 'https://'+app.get('domain')+':'+app.get('port_secure');

/**
 * Create HTTP server.
 */

var server = http.createServer(app);
/* This data is from the keys directory, generated by OpenSSL */
var secureServer = https.createServer({
        key: "-----BEGIN RSA PRIVATE KEY-----\n"
"MIICXAIBAAKBgQCrNlM9wFDegJgJBeLbZ4hnP3WKubyUXEKVxRKins8p7dkJdsZS\n"
"OVv9QBUwKMGciS5VspH7BFKRu+CRCzbL102WKIOU/jPVhFSdg01wm+/ZQejQmNn1\n"
"9UOqO6zy/vLWhWNqbG8m7Nbic8xTBhfhkrkvLxDeGEuoojnB1txBfYFmdwIDAQAB\n"
"AoGAVzDIPXdV96nnQxkTSYa1KVdg5a/nAGrnodwFvHlBqOmukKpDHxaE6TicUbU/\n"
"vBcEWLIis4GlBwB1wYfDdRWFNbDAm9ngfOQdm12VqKez0x/sxcaastcvuPrhurRo\n"
"HZh/MGrqY4yZ4/Hbjs08gHNEVltXKfimyVV+d3RuaRh4IjkCQQDX1nfIxxxTB2c0\n"
"N1lEF/2xd8LgeR6NRvY7QqAyfsqEQa7KF3OkfvTfXX4/Gu2laMAGpZq9FopTpwIu\n"
"tPazLao1AkEAyxIZHdvM6Jj9+872LGrU7mW0JGuJyklr21TD3AaPNbTYLMmObSSK\n"
"Lk4igsXV7gd37Xm+EaZtAsiOlwq1SYoDewJBAKfWPFtCicH+1cAC8kVDKqGf8UhA\n"
"pwNRFRRL4OqjMbPap6K6zdAycRRoTU2hEP85D2mbyVIUfwhBrC7JxbTbY6kCQH/X\n"
"MuyzNTqxJiPiVOP9lXNHn7LV6Hbq5fW8VVks3/dllDoN4ZYgTMV99wfw2A7zsLJV\n"
"1Cx0Y2g/LlU0LpDPTAUCQCsCZy9IyPeCTtjAENDc8AvwpLqMDXTLIaze8Ercaicp\n"
"UKCnIESZZ17nSBhy/Wo1qLAven9gJXJB6kqQ+XyYvME=\n"
"-----END RSA PRIVATE KEY-----\n"
"",
        cert: "-----BEGIN CERTIFICATE-----\n"
"MIICrTCCAhYCCQDEcesiVzYGwzANBgkqhkiG9w0BAQUFADCBmjELMAkGA1UEBhMC\n"
"TloxFTATBgNVBAgTDE5vcnRoIElzbGFuZDETMBEGA1UEBxMKV2VsbGluZ3RvbjEc\n"
"MBoGA1UEChMTVmljdG9yaWEgVW5pdmVyc2l0eTEQMA4GA1UECxMHc3R1ZGVudDEQ\n"
"MA4GA1UEAxMHR3JvdXAgMzEdMBsGCSqGSIb3DQEJARYOYWxjaW5uekBlbWwuY2Mw\n"
"HhcNMTYwNTIwMDgyNDEzWhcNMTYwNjE5MDgyNDEzWjCBmjELMAkGA1UEBhMCTlox\n"
"FTATBgNVBAgTDE5vcnRoIElzbGFuZDETMBEGA1UEBxMKV2VsbGluZ3RvbjEcMBoG\n"
"A1UEChMTVmljdG9yaWEgVW5pdmVyc2l0eTEQMA4GA1UECxMHc3R1ZGVudDEQMA4G\n"
"A1UEAxMHR3JvdXAgMzEdMBsGCSqGSIb3DQEJARYOYWxjaW5uekBlbWwuY2MwgZ8w\n"
"DQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAKs2Uz3AUN6AmAkF4ttniGc/dYq5vJRc\n"
"QpXFEqKezynt2Ql2xlI5W/1AFTAowZyJLlWykfsEUpG74JELNsvXTZYog5T+M9WE\n"
"VJ2DTXCb79lB6NCY2fX1Q6o7rPL+8taFY2psbybs1uJzzFMGF+GSuS8vEN4YS6ii\n"
"OcHW3EF9gWZ3AgMBAAEwDQYJKoZIhvcNAQEFBQADgYEAMwY5wJUMM/YVN7kqv3i5\n"
"P5l/Jvcv2V025RiKE2NP40wL3RLpDLrhhKG257bKa9rTIAieCiy4+FmVb8HfKdqj\n"
"5XXF2TajnVVVf2e4XSRjnDPo7J9+qFeNkNbAocwh9wn1xJW2sZG1VAd5n50UD3nL\n"
"gXkKKDv6CHBcf4uE9BKrZy0=\n"
"-----END CERTIFICATE-----\n"
""
    },app)

var fixtures = ['fixtures/user_test_data.json',
                'fixtures/listing_test_data.json',
                'fixtures/picture_test_data.json'];

models.sequelize.sync({force:true}).then(function () {
    sequelize_fixtures.loadFiles(fixtures, models).then(function () {
        server.listen(app.get('port'), function () {
            console.log('Express server listening on port ' + server.address().port);
        });
        secureServer.listen(app.get('port_secure'), function() {
            console.log('Secure Express server listening on port ' + secureServer.address().port);
        });
    });
});





